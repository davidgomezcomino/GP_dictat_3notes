<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenador d'Intervals</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
import React, { useState, useEffect } from 'react';
import { Volume2, CheckCircle, XCircle, RotateCcw } from 'lucide-react';

const IntervalTrainer = () => {
  const [audioContext, setAudioContext] = useState(null);
  const [currentExercise, setCurrentExercise] = useState(null);
  const [selectedAnswer, setSelectedAnswer] = useState('');
  const [feedback, setFeedback] = useState(null);
  const [score, setScore] = useState({ correct: 0, total: 0 });

  const intervals = [
    { id: '2M', name: '2a Major', semitones: 2 },
    { id: '3M', name: '3a Major', semitones: 4 },
    { id: '4J', name: '4a Justa', semitones: 5 },
    { id: '5J', name: '5a Justa', semitones: 7 }
  ];

  const scales = {
    'C': [0, 2, 4, 5, 7, 9, 11],
    'G': [7, 9, 11, 0, 2, 4, 6],
    'D': [2, 4, 6, 7, 9, 11, 1],
    'A': [9, 11, 1, 2, 4, 6, 8],
    'E': [4, 6, 8, 9, 11, 1, 3],
    'F': [5, 7, 9, 10, 0, 2, 4],
    'Bb': [10, 0, 2, 3, 5, 7, 9],
    'Eb': [3, 5, 7, 8, 10, 0, 2],
    'Ab': [8, 10, 0, 1, 3, 5, 7],
    'Db': [1, 3, 5, 6, 8, 10, 0]
  };

  useEffect(() => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    setAudioContext(ctx);
    generateExercise();
  }, []);

  const generateExercise = () => {
    const scaleKeys = Object.keys(scales);
    const randomKey = scaleKeys[Math.floor(Math.random() * scaleKeys.length)];
    const scale = scales[randomKey];
    
    // Començar des d'un grau baix per assegurar que tenim espai per pujar
    const startDegree = Math.floor(Math.random() * 3); // Graus 0, 1 o 2
    const note1Pitch = scale[startDegree];
    
    const availableIntervals = intervals.filter(int => {
      const note2Index = startDegree + getScaleDegrees(int.id) - 1;
      if (note2Index >= 7) return false;
      const note2Pitch = scale[note2Index];
      const actualSemitones = (note2Pitch - note1Pitch + 12) % 12;
      return actualSemitones === int.semitones;
    });

    if (availableIntervals.length === 0) {
      generateExercise();
      return;
    }

    const int1 = availableIntervals[Math.floor(Math.random() * availableIntervals.length)];
    const note2Index = startDegree + getScaleDegrees(int1.id) - 1;
    const note2Pitch = scale[note2Index];

    const availableIntervals2 = intervals.filter(int => {
      const note3Index = note2Index + getScaleDegrees(int.id) - 1;
      if (note3Index >= 7) return false;
      const note3Pitch = scale[note3Index];
      const actualSemitones = (note3Pitch - note2Pitch + 12) % 12;
      return actualSemitones === int.semitones;
    });

    if (availableIntervals2.length === 0) {
      generateExercise();
      return;
    }

    const int2 = availableIntervals2[Math.floor(Math.random() * availableIntervals2.length)];
    const note3Index = note2Index + getScaleDegrees(int2.id) - 1;
    const note3Pitch = scale[note3Index];

    // Convertir a MIDI amb registre baix per tenir millor so
    const baseOctave = 60; // Do central
    const note1 = note1Pitch + baseOctave;
    const note2 = note2Pitch + baseOctave;
    const note3 = note3Pitch + baseOctave;

    // VERIFICACIÓ: assegurar que les notes són ascendents
    if (note1 >= note2 || note2 >= note3) {
      generateExercise();
      return;
    }

    setCurrentExercise({
      key: randomKey,
      notes: [note1, note2, note3],
      intervals: [int1.id, int2.id],
      answerKey: `${int1.id}-${int2.id}`
    });
    setSelectedAnswer('');
    setFeedback(null);
  };

  const getScaleDegrees = (intervalId) => {
    const degreesMap = {
      '2M': 2,
      '3M': 3,
      '4J': 4,
      '5J': 5
    };
    return degreesMap[intervalId];
  };

  const playNotes = (sequential = false) => {
    if (!audioContext || !currentExercise) return;
    
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }

    const startTime = audioContext.currentTime;
    
    // Primera nota: Piano (ric en harmònics)
    const playPiano = (freq, delay) => {
      const harmonics = [1, 2, 3, 4, 5];
      const amplitudes = [1, 0.5, 0.3, 0.2, 0.1];
      
      harmonics.forEach((harmonic, i) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        osc.frequency.value = freq * harmonic;
        osc.type = 'sine';
        
        const vol = 0.15 * amplitudes[i];
        const noteStart = startTime + delay;
        gain.gain.setValueAtTime(0, noteStart);
        gain.gain.linearRampToValueAtTime(vol, noteStart + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.01, noteStart + 1.2);
        
        osc.start(noteStart);
        osc.stop(noteStart + 1.25);
      });
    };
    
    // Segona nota: Flauta (pocs harmònics, so suau)
    const playFlute = (freq, delay) => {
      const osc1 = audioContext.createOscillator();
      const osc2 = audioContext.createOscillator();
      const gain = audioContext.createGain();
      
      osc1.connect(gain);
      osc2.connect(gain);
      gain.connect(audioContext.destination);
      
      osc1.frequency.value = freq;
      osc2.frequency.value = freq * 2;
      osc1.type = 'sine';
      osc2.type = 'sine';
      
      const noteStart = startTime + delay;
      gain.gain.setValueAtTime(0, noteStart);
      gain.gain.linearRampToValueAtTime(0.12, noteStart + 0.1);
      gain.gain.setValueAtTime(0.12, noteStart + 1.0);
      gain.gain.exponentialRampToValueAtTime(0.01, noteStart + 1.2);
      
      osc1.start(noteStart);
      osc2.start(noteStart);
      osc1.stop(noteStart + 1.25);
      osc2.stop(noteStart + 1.25);
    };
    
    // Tercera nota: Violí (harmònics més pronunciats)
    const playViolin = (freq, delay) => {
      const harmonics = [1, 2, 3, 4, 5, 6];
      const amplitudes = [0.8, 0.6, 0.4, 0.3, 0.2, 0.1];
      
      harmonics.forEach((harmonic, i) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        osc.frequency.value = freq * harmonic;
        osc.type = 'sine';
        
        const vol = 0.08 * amplitudes[i];
        const noteStart = startTime + delay;
        gain.gain.setValueAtTime(0, noteStart);
        gain.gain.linearRampToValueAtTime(vol, noteStart + 0.15);
        gain.gain.setValueAtTime(vol * 0.9, noteStart + 1.0);
        gain.gain.exponentialRampToValueAtTime(0.01, noteStart + 1.2);
        
        osc.start(noteStart);
        osc.stop(noteStart + 1.25);
      });
    };
    
    const freq1 = 440 * Math.pow(2, (currentExercise.notes[0] - 69) / 12);
    const freq2 = 440 * Math.pow(2, (currentExercise.notes[1] - 69) / 12);
    const freq3 = 440 * Math.pow(2, (currentExercise.notes[2] - 69) / 12);
    
    if (sequential) {
      playPiano(freq1, 0);
      playFlute(freq2, 0.7);
      playViolin(freq3, 1.4);
    } else {
      playPiano(freq1, 0);
      playFlute(freq2, 0);
      playViolin(freq3, 0);
    }
  };

  const checkAnswer = (answerKey) => {
    if (!currentExercise || feedback !== null) return;

    const correct = answerKey === currentExercise.answerKey;
    
    setSelectedAnswer(answerKey);
    setFeedback({
      correct,
      correctIntervals: currentExercise.intervals
    });
    
    setScore(prev => ({
      correct: prev.correct + (correct ? 1 : 0),
      total: prev.total + 1
    }));
  };

  const getAllPossibleAnswers = () => {
    const answers = [];
    // Ordenar per primer interval, després per segon interval
    intervals.forEach(int1 => {
      intervals.forEach(int2 => {
        answers.push({
          key: `${int1.id}-${int2.id}`,
          label: `${int1.id} + ${int2.id}`,
          firstInterval: int1.id
        });
      });
    });
    return answers;
  };

  const nextExercise = () => {
    generateExercise();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-100 p-8">
      <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8">
        <h1 className="text-3xl font-bold text-center text-indigo-900 mb-2">
          Entrenador d'Intervals
        </h1>
        <p className="text-center text-gray-600 mb-6">
          Escolta les tres notes i identifica els intervals (2M, 3M, 4J, 5J)
        </p>

        <div className="bg-indigo-50 rounded-lg p-6 mb-6">
          <div className="flex justify-between items-center mb-4">
            <div className="text-lg font-semibold text-indigo-900">
              Puntuació: {score.correct} / {score.total}
            </div>
            {score.total > 0 && (
              <div className="text-sm text-gray-600">
                {Math.round((score.correct / score.total) * 100)}% encerts
              </div>
            )}
          </div>

          <div className="grid grid-cols-2 gap-3">
            <button
              onClick={() => playNotes(false)}
              className="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
            >
              <Volume2 size={24} />
              Notes Juntes
            </button>
            <button
              onClick={() => playNotes(true)}
              className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
            >
              <Volume2 size={24} />
              Notes Separades
            </button>
          </div>
        </div>

        <div className="space-y-4">
          <p className="text-center text-gray-700 font-medium mb-4">
            Quins intervals escoltes?
          </p>
          
          <div className="space-y-2">
            {intervals.map(int1 => (
              <div key={int1.id} className="grid grid-cols-4 gap-2">
                {getAllPossibleAnswers()
                  .filter(answer => answer.firstInterval === int1.id)
                  .map(answer => (
                    <button
                      key={answer.key}
                      onClick={() => checkAnswer(answer.key)}
                      disabled={feedback !== null}
                      className={`p-3 rounded-lg font-semibold text-sm transition-all ${
                        feedback === null
                          ? 'bg-indigo-50 hover:bg-indigo-100 text-indigo-900 border-2 border-indigo-200 hover:border-indigo-400'
                          : answer.key === currentExercise.answerKey
                          ? 'bg-green-100 text-green-800 border-2 border-green-400'
                          : answer.key === selectedAnswer
                          ? 'bg-red-100 text-red-800 border-2 border-red-400'
                          : 'bg-gray-100 text-gray-500 border-2 border-gray-200'
                      } ${feedback !== null ? 'cursor-default' : 'cursor-pointer'}`}
                    >
                      {answer.label}
                    </button>
                  ))}
              </div>
            ))}
          </div>

          {feedback && (
            <div className={`p-4 rounded-lg mt-4 ${feedback.correct ? 'bg-green-100' : 'bg-red-100'}`}>
              <div className="flex items-center gap-2">
                {feedback.correct ? (
                  <>
                    <CheckCircle className="text-green-600" size={24} />
                    <span className="font-semibold text-green-800">Correcte!</span>
                  </>
                ) : (
                  <>
                    <XCircle className="text-red-600" size={24} />
                    <span className="font-semibold text-red-800">Incorrecte</span>
                  </>
                )}
              </div>
            </div>
          )}

          {feedback && (
            <button
              onClick={nextExercise}
              className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center gap-2 transition-colors mt-4"
            >
              <RotateCcw size={20} />
              Següent Exercici
            </button>
          )}
        </div>

        <div className="mt-8 p-4 bg-gray-50 rounded-lg">
          <h3 className="font-semibold text-gray-700 mb-2">Com jugar:</h3>
          <ol className="text-sm text-gray-600 space-y-1 list-decimal list-inside">
            <li>Prem "Notes Juntes" per escoltar l'acord sencer</li>
            <li>Prem "Notes Separades" per escoltar-les una per una</li>
            <li>Clica el botó amb la combinació d'intervals correcta</li>
            <li>Comprova la teva resposta i continua practicant!</li>
          </ol>
        </div>
      </div>
    </div>
  );
};

export default IntervalTrainer;    </script>
</body>
</html>
